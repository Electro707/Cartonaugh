%%
%% This is file `cartonaugh.sty',
%% generated with the docstrip utility.
%%
%% The original source files were:
%%
%% cartonaugh.dtx  (with options: `package')
%% 
%% IMPORTANT NOTICE:
%% 
%% For the copyright see the source file.
%% 
%% Any modified versions of this file must be renamed
%% with new filenames distinct from cartonaugh.sty.
%% 
%% For distribution of the original source see the terms
%% for copying and modification in the file cartonaugh.dtx.
%% 
%% This generated file may be distributed as long as the
%% original source files, as listed above, are part of the
%% same distribution. (The sources need not necessarily be
%% in the same archive or directory.)
%%
%% Copyright (C) 2015, 2016, 2017 Mattias Jacobsson and contributors
%% This work, karnaugh-map, is written from the ground up by Mattias Jacobsson. However the general implementation idea is based on the work published on [TeX - LaTeX Stack Exchange](https://tex.stackexchange.com) by [Ignasi](https://tex.stackexchange.com/users/1952/ignasi) found [here](https://tex.stackexchange.com/a/140581) and [here](https://tex.stackexchange.com/a/36879) which is licensed under [CC BY-SA](https://creativecommons.org/licenses/by-sa/3.0/). karnaugh-map is therefore licensed under [CC BY-SA](https://creativecommons.org/licenses/by-sa/3.0/). Contributors include [Oscar Gustafsson](https://github.com/oscargus).
%%

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{karnaugh-map}[2017/02/20 v1.1 Draw Karnaugh Maps]

%%
%% Dependencies
%%

%% parsing arguments
\RequirePackage{xparse}

%% working with strings
\RequirePackage{xstring}

%% drawing
\RequirePackage{tikz}
\usetikzlibrary{calc,matrix}

%%
%% Helpers
%%

\directlua{require("cartonaugh")}

%% convert decimal to color
\newcommand{\@karnaughmap@func@decimaltocolor@}[1]{%
  \ifnum#1=0 red\fi
  \ifnum#1=1 green\fi
  \ifnum#1=2 yellow\fi
  \ifnum#1=3 cyan\fi
  \ifnum#1=4 blue\fi
  \ifnum#1=5 magenta\fi
  \ifnum#1>5 cyan\fi
}

%% convert decimal to binary 6-bit
\newcommand{\@karnaughmap@func@decimaltobin@}[1]{\directlua{tex.sprint(decimalToBin(\the\numexpr(#1)\relax, 6))}}

%% command raises an error if executed outside the karnaugh-map environment
\newcommand{\@karnaughmap@func@bailoutsideenvironment@}[0]{%
  \ifnum\@karnaughmap@var@mapsizex@\@karnaughmap@var@mapsizey@\@karnaughmap@var@mapsizez@=000
    \PackageError{karnaugh-map}{%
      Command can not be used outside karnaugh-map environment%
    }{%
      Do not use this command outside the karnaugh-map environment.%
    }
  \fi
}

%% store map size
\newcommand{\@karnaughmap@var@mapsizex@}{0}
\newcommand{\@karnaughmap@var@mapsizey@}{0}
\newcommand{\@karnaughmap@var@mapsizez@}{0}

%% render in black and white or color default to '0'(false/color)
\newcommand{\@karnaughmap@var@bw@}{0}
\NewDocumentEnvironment{karnaugh-map}{s O{4} O{4} O{1} O{$X_1X_0$} O{$X_3X_2$} O{$X_5X_4$}} {%
  \begingroup
    % store map size {[START]
      \renewcommand{\@karnaughmap@var@mapsizex@}{#2}%
      \renewcommand{\@karnaughmap@var@mapsizey@}{#3}%
      \renewcommand{\@karnaughmap@var@mapsizez@}{#4}%
    % [END]}
    % determinate if markings should be color or black and white
    \IfBooleanTF{#1}{%
      % should be black and white
      \renewcommand{\@karnaughmap@var@bw@}{1}%
    }{%
      % should be color
      \renewcommand{\@karnaughmap@var@bw@}{0}%
    }%
    %

    % [END]}
    % test if a matrix template is found or not(aka "\@karnaughmap@local@matrixtemplate@" equals to '0')
    \begin{tikzpicture}
        \directlua{draw_pgf_kmap(
                   \the\numexpr(\@karnaughmap@var@mapsizex@)\relax,
                   \the\numexpr(\@karnaughmap@var@mapsizey@)\relax,
                   \the\numexpr(\@karnaughmap@var@mapsizez@)\relax,
                   "\luaescapestring{\detokenize{#5}}",
                   "\luaescapestring{\detokenize{#6}}"
                   )}
}{
    \end{tikzpicture}
  \endgroup
}

%%
%% Commands for filling out the cells
%%

%% store already used cells to avoid double filled cells and for auto completion
\newcommand{\@karnaughmap@var@usedcells@}{,}

\DeclareDocumentCommand{\autoterms}{O{-}} {%
  % bail if outside environment karnaugh-map
  \@karnaughmap@func@bailoutsideenvironment@{}
  %
  \begingroup
    % calculate max cell number {[START]
      \newcount\@karnaughmap@local@max@\relax
      \@karnaughmap@local@max@=\@karnaughmap@var@mapsizex@\relax
      \multiply\@karnaughmap@local@max@ by \@karnaughmap@var@mapsizey@\relax
      \multiply\@karnaughmap@local@max@ by \@karnaughmap@var@mapsizez@\relax
      \advance\@karnaughmap@local@max@ by -1\relax
    % [END]}
    % fill terms
    \foreach \cell in {0,1,2,...,\@karnaughmap@local@max@} {%
      \IfSubStr{\@karnaughmap@var@usedcells@}{,\cell,}{}{%
        \path (\@karnaughmap@func@decimaltobin@{\cell}) node {#1};
      }
    }
  \endgroup
  % update \@karnaughmap@var@usedcells@ (all cells are used now)
  \renewcommand{\@karnaughmap@var@usedcells@}{,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,}
}
\DeclareDocumentCommand{\indeterminants}{m} {%
  % bail if outside environment karnaugh-map
  \@karnaughmap@func@bailoutsideenvironment@{}
  %
  \terms{#1}{-}
}
\DeclareDocumentCommand{\manualterms}{m} {%
  % bail if outside environment karnaugh-map
  \@karnaughmap@func@bailoutsideenvironment@{}
  %
  \foreach \cellinfo [count=\cell from 0] in {#1} {%
    % only write to cell if it is empty otherwise fail silently
    \IfSubStr{\@karnaughmap@var@usedcells@}{,\cell,}{}{%
      \path (\@karnaughmap@func@decimaltobin@{\cell}) node {\cellinfo};
    }
  }
  % update \@karnaughmap@var@usedcells@ (previous cells + all cells up to \@karnaughmap@local@cellcount@ are used now) {[START]
    \newcommand{\@karnaughmap@local@tmpusedcells@}{}
    \newcount\@karnaughmap@local@cellcount@\relax
    % count number of cells in #1 {[START]
      \StrCount{#1}{,}[\@karnaughmap@local@tmpusedcells@]
      \@karnaughmap@local@cellcount@=\@karnaughmap@local@tmpusedcells@\relax
      \advance\@karnaughmap@local@cellcount@ by 1\relax
      \multiply\@karnaughmap@local@cellcount@ by 2\relax
    % [END]}
    % create sequence for \@karnaughmap@local@tmpusedcells@
    \StrLeft{0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,}{\@karnaughmap@local@cellcount@}[\@karnaughmap@local@tmpusedcells@]
    % update \@karnaughmap@var@usedcells@ (append \@karnaughmap@local@tmpusedcells@)
    \expandafter\def\expandafter\@karnaughmap@var@usedcells@\expandafter{\@karnaughmap@var@usedcells@\@karnaughmap@local@tmpusedcells@}
  % [END]}
}
\DeclareDocumentCommand{\maxterms}{m} {%
  % bail if outside environment karnaugh-map
  \@karnaughmap@func@bailoutsideenvironment@{}
  %
  \terms{#1}{0}
}
\DeclareDocumentCommand{\minterms}{m} {%
  % bail if outside environment karnaugh-map
  \@karnaughmap@func@bailoutsideenvironment@{}
  %
  \terms{#1}{1}
}
\DeclareDocumentCommand{\terms}{m m} {%
  % bail if outside environment karnaugh-map
  \@karnaughmap@func@bailoutsideenvironment@{}
  %
  \foreach \cell in {#1} {%
    % only write to cell if it is empty otherwise fail silently
    \IfSubStr{\@karnaughmap@var@usedcells@}{,\cell,}{}{%
      \path (\@karnaughmap@func@decimaltobin@{\cell}) node {#2};
    }
  }
  % update \@karnaughmap@var@usedcells@
  \expandafter\def\expandafter\@karnaughmap@var@usedcells@\expandafter{\@karnaughmap@var@usedcells@#1,}
}

%%
%% Commands for marking the cells
%%

%% keep track of used colors
\newcount\@karnaughmap@var@colorindex@\relax
\@karnaughmap@var@colorindex@=0\relax

\DeclareDocumentCommand{\implicant}{m m O{0}} {%
  % bail if outside environment karnaugh-map
  \@karnaughmap@func@bailoutsideenvironment@{}
  %
  \begingroup
    % loop through specified sub maps
    \foreach \map in {#3} {%
      % make sure we don't try to draw on non existing sub maps
      \ifnum\map<\@karnaughmap@var@mapsizez@
        % calculate cell number for the specified sub maps {[START]
          \newcount\@karnaughmap@local@northwest@\relax
          \newcount\@karnaughmap@local@southeast@\relax
          \@karnaughmap@local@northwest@=\map\relax
          \@karnaughmap@local@southeast@=\map\relax
          \multiply\@karnaughmap@local@northwest@ by 16\relax
          \multiply\@karnaughmap@local@southeast@ by 16\relax
          \advance\@karnaughmap@local@northwest@ by #1\relax
          \advance\@karnaughmap@local@southeast@ by #2\relax
        % [END]}
        % only fill marking when \@karnaughmap@var@bw@ = '0'
        \ifnum0=\@karnaughmap@var@bw@
          \fill[
            rounded corners=3pt,
            fill=\@karnaughmap@func@decimaltocolor@{\@karnaughmap@var@colorindex@},
            fill opacity=0.25,
          ] {
            ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@northwest@}.center)+(-0.3,0.3)$)
            rectangle
            ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@southeast@}.center)+(0.3,-0.3)$)
          };
        \fi
        \draw[
          rounded corners=3pt,
          draw opacity=1.0,
        ] {
          ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@northwest@}.center)+(-0.3,0.3)$)
          rectangle
          ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@southeast@}.center)+(0.3,-0.3)$)
        };
      \else
        \PackageWarning{karnaugh-map}{%
          You can only draw on existing sub maps.
          Ignoring instruction to draw on non existing sub map number \map%
        }
      \fi
    }
  \endgroup
  % mark color as used
  \advance\@karnaughmap@var@colorindex@ by 1\relax
}
\DeclareDocumentCommand{\implicantedge}{m m m m O{0}} {%
  % bail if outside environment karnaugh-map
  \@karnaughmap@func@bailoutsideenvironment@{}
  %
  \begingroup
    % helper variables {[START]
      \newcommand{\@karnaughmap@local@orientation@}{0} % '0' is a vertical and '1' is a horizontal implicant
      \newcommand{\@karnaughmap@local@coordinateone@}{0}
      \newcommand{\@karnaughmap@local@coordinatetwo@}{0}
      \newcommand{\@karnaughmap@local@mirror@}{1} % '1' or '-1' to mirror
      \newcommand{\@karnaughmap@local@bordercontent@}{}
      \newcommand{\@karnaughmap@local@fillcontent@}{}
    % [END]}
    % determinate if this is an horizontal or vertical implicant {[START]
      \newcount\@karnaughmap@local@testcaseone@\relax
      \newcount\@karnaughmap@local@testcasetwo@\relax
      \@karnaughmap@local@testcaseone@=#1\relax
      \@karnaughmap@local@testcasetwo@=#1\relax
      \advance\@karnaughmap@local@testcaseone@ by -#2\relax
      \advance\@karnaughmap@local@testcasetwo@ by -#3\relax
      \ifnum\@karnaughmap@local@testcaseone@<0 \multiply\@karnaughmap@local@testcaseone@ by -1\relax\fi
      \ifnum\@karnaughmap@local@testcasetwo@<0 \multiply\@karnaughmap@local@testcasetwo@ by -1\relax\fi
      % test case one
      \ifnum\@karnaughmap@local@testcaseone@<\@karnaughmap@var@mapsizex@
        % this is a vertical implicant
        \renewcommand{\@karnaughmap@local@orientation@}{0}
      \else
        % this is a horizontal implicant
        \renewcommand{\@karnaughmap@local@orientation@}{1}
      \fi
      % test case two
      \ifnum\@karnaughmap@local@testcasetwo@<\@karnaughmap@var@mapsizex@
        % this is a vertical implicant
        \renewcommand{\@karnaughmap@local@orientation@}{1}
      \fi
    % [END]}
    % loop through specified sub maps
    \foreach \map in {#5} {%
      % make sure we don't try to draw on non existing sub maps
      \ifnum\map<\@karnaughmap@var@mapsizez@
        % loop through both parts of the marking(ie. left and right part)
        \foreach \i in {0,1} {%
          % set parameters depending on the part of the marking(ie. left and right part) {[START]
            \ifnum\i=0
              \renewcommand{\@karnaughmap@local@coordinateone@}{#1}
              \renewcommand{\@karnaughmap@local@coordinatetwo@}{#2}
              \renewcommand{\@karnaughmap@local@mirror@}{1}
            \else
              \renewcommand{\@karnaughmap@local@coordinateone@}{#3}
              \renewcommand{\@karnaughmap@local@coordinatetwo@}{#4}
              \renewcommand{\@karnaughmap@local@mirror@}{-1}
            \fi
          % [END]}
          % calculate cell numbers for the specified sub map {[START]
            \newcount\@karnaughmap@local@coordinateonecounter@\relax
            \newcount\@karnaughmap@local@coordinatetwocounter@\relax
            \@karnaughmap@local@coordinateonecounter@=\map\relax
            \@karnaughmap@local@coordinatetwocounter@=\map\relax
            \multiply\@karnaughmap@local@coordinateonecounter@ by 16\relax
            \multiply\@karnaughmap@local@coordinatetwocounter@ by 16\relax
            \advance\@karnaughmap@local@coordinateonecounter@ by \@karnaughmap@local@coordinateone@\relax
            \advance\@karnaughmap@local@coordinatetwocounter@ by \@karnaughmap@local@coordinatetwo@\relax
            \renewcommand{\@karnaughmap@local@coordinateone@}{\@karnaughmap@local@coordinateonecounter@}
            \renewcommand{\@karnaughmap@local@coordinatetwo@}{\@karnaughmap@local@coordinatetwocounter@}
          % [END]}
          % select drawing content depending on orientation {[START]
            \ifnum\@karnaughmap@local@orientation@=0
              % this is a vertical implicant
              \renewcommand{\@karnaughmap@local@fillcontent@}{%
                ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinateone@}.center)+(-.3,.6*\@karnaughmap@local@mirror@)$)
                --
                ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinatetwo@}.center)+(.3,.6*\@karnaughmap@local@mirror@)$)
                { [rounded corners=3pt] --
                ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinatetwo@}.center)+(.3,-.3*\@karnaughmap@local@mirror@)$) }
                { [rounded corners=3pt] --
                ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinateone@}.center)+(-.3,-.3*\@karnaughmap@local@mirror@)$) }
                -- cycle
              }
              \renewcommand{\@karnaughmap@local@bordercontent@}{%
                ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinatetwo@}.center)+(.3,.6*\@karnaughmap@local@mirror@)$)
                { [rounded corners=3pt] --
                ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinatetwo@}.center)+(.3,-.3*\@karnaughmap@local@mirror@)$) }
                { [rounded corners=3pt] --
                ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinateone@}.center)+(-.3,-.3*\@karnaughmap@local@mirror@)$) }
                --
                ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinateone@}.center)+(-.3,.6*\@karnaughmap@local@mirror@)$)
              }
            \else
              % this is a horizontal implicant
              \renewcommand{\@karnaughmap@local@fillcontent@}{%
                ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinatetwo@}.center)+(-.6*\@karnaughmap@local@mirror@,-.3)$)
                --
                ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinateone@}.center)+(-.6*\@karnaughmap@local@mirror@,.3)$)
                { [rounded corners=3pt] --
                ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinateone@}.center)+(.3*\@karnaughmap@local@mirror@,.3)$) }
                { [rounded corners=3pt] --
                ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinatetwo@}.center)+(.3*\@karnaughmap@local@mirror@,-.3)$) }
                -- cycle
              }
              \renewcommand{\@karnaughmap@local@bordercontent@}{%
                ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinateone@}.center)+(-.6*\@karnaughmap@local@mirror@,.3)$)
                { [rounded corners=3pt] --
                ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinateone@}.center)+(.3*\@karnaughmap@local@mirror@,.3)$) }
                { [rounded corners=3pt] --
                ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinatetwo@}.center)+(.3*\@karnaughmap@local@mirror@,-.3)$) }
                --
                ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinatetwo@}.center)+(-.6*\@karnaughmap@local@mirror@,-.3)$)
              }
            \fi
          % [END]}
          % draw
          % only fill marking when \@karnaughmap@var@bw@ = '0'
          \ifnum0=\@karnaughmap@var@bw@
            \fill[
              sharp corners,
              fill=\@karnaughmap@func@decimaltocolor@{\@karnaughmap@var@colorindex@},
              fill opacity=0.25,
            ] {
              \@karnaughmap@local@fillcontent@%
            };
          \fi
          \draw[
            sharp corners,
            draw opacity=1.0,
          ] {
            \@karnaughmap@local@bordercontent@%
          };
        }
      \else
        \PackageWarning{karnaugh-map}{%
          You can only draw on existing sub maps.
          Ignoring instruction to draw on non existing sub map number \map%
        }
      \fi
    }
  \endgroup
  % mark color as used
  \advance\@karnaughmap@var@colorindex@ by 1\relax
}
\DeclareDocumentCommand{\implicantcorner}{O{0}} {%
  % bail if outside environment karnaugh-map
  \@karnaughmap@func@bailoutsideenvironment@{}
  %
  % make sure "\implicantcorner" only are used on 4x4 maps
  \ifnum\@karnaughmap@var@mapsizex@\@karnaughmap@var@mapsizey@=44
    % loop through specified sub maps
    \foreach \map in {#1} {%
      % make sure we don't try to draw on non existing sub maps
      \ifnum\map<\@karnaughmap@var@mapsizez@
        % loop through the four corners
        \foreach \corner in {0,2,8,10} {%
          % calculate corner's properties {[START]
            \newcount\@karnaughmap@local@coordinate@\relax
            \@karnaughmap@local@coordinate@=\map\relax
            \multiply\@karnaughmap@local@coordinate@ by 16\relax
            \advance\@karnaughmap@local@coordinate@ by \corner\relax
            \newcommand{\@karnaughmap@local@mirrorx@}{0} % '1' or '-1' to mirror
            \newcommand{\@karnaughmap@local@mirrory@}{0} % '1' or '-1' to mirror
            \ifnum\corner=0 \renewcommand{\@karnaughmap@local@mirrorx@}{1}\renewcommand{\@karnaughmap@local@mirrory@}{1}\fi
            \ifnum\corner=2 \renewcommand{\@karnaughmap@local@mirrorx@}{-1}\renewcommand{\@karnaughmap@local@mirrory@}{1}\fi
            \ifnum\corner=8 \renewcommand{\@karnaughmap@local@mirrorx@}{1}\renewcommand{\@karnaughmap@local@mirrory@}{-1}\fi
            \ifnum\corner=10 \renewcommand{\@karnaughmap@local@mirrorx@}{-1}\renewcommand{\@karnaughmap@local@mirrory@}{-1}\fi
          % [END]}
          % draw
          % only fill marking when \@karnaughmap@var@bw@ = '0'
          \ifnum0=\@karnaughmap@var@bw@
            \fill[
              sharp corners,
              fill=\@karnaughmap@func@decimaltocolor@{\@karnaughmap@var@colorindex@},
              fill opacity=0.25,
            ]
            ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinate@}.center)+(-.6*\@karnaughmap@local@mirrorx@,.6*\@karnaughmap@local@mirrory@)$)
            --
            ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinate@}.center)+(.3*\@karnaughmap@local@mirrorx@,.6*\@karnaughmap@local@mirrory@)$)
            { [rounded corners=3pt] --
            ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinate@}.center)+(.3*\@karnaughmap@local@mirrorx@,-.3*\@karnaughmap@local@mirrory@)$) }
            --
            ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinate@}.center)+(-.6*\@karnaughmap@local@mirrorx@,-.3*\@karnaughmap@local@mirrory@)$)
            -- cycle;
          \fi
          \draw[
            sharp corners,
            draw opacity=1.0,
          ]
          ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinate@}.center)+(.3*\@karnaughmap@local@mirrorx@,.6*\@karnaughmap@local@mirrory@)$)
          { [rounded corners=3pt] --
          ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinate@}.center)+(.3*\@karnaughmap@local@mirrorx@,-.3*\@karnaughmap@local@mirrory@)$) }
          --
          ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinate@}.center)+(-.6*\@karnaughmap@local@mirrorx@,-.3*\@karnaughmap@local@mirrory@)$);
        }
      \else
        \PackageWarning{karnaugh-map}{%
          You can only draw on existing sub maps.
          Ignoring instruction to draw on non existing sub map number \map%
        }
      \fi
    }
    % mark color as used
    \advance\@karnaughmap@var@colorindex@ by 1\relax
  \else
    % print error if "\implicantcorner" are used on non 4x4 map
    \PackageError{karnaugh-map}{%
      \protect\implicantcorner\space can only be used on 4x4 maps%
    }{%
      You are trying to use \protect\implicantcorner\space on non 4x4 map.%
    }
  \fi
}

\endinput
%%
%% End of file `cartonaugh.sty'.
